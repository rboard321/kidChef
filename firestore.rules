rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isParentOfKid(kidId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/kidProfiles/$(kidId)) &&
        isOwnerOfParentProfile(get(/databases/$(database)/documents/kidProfiles/$(kidId)).data.parentId);
    }

    function isOwnerOfParentProfile(parentId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/parentProfiles/$(parentId)) &&
        get(/databases/$(database)/documents/parentProfiles/$(parentId)).data.userId == request.auth.uid;
    }

    // Legacy User Profiles (for backward compatibility during migration)
    match /userProfiles/{userId} {
      allow read, write: if isOwner(userId);
      allow create: if isAuthenticated() && userId == request.auth.uid;
      // Temporary: Allow querying during migration only
      allow list: if isAuthenticated();
    }

    // Parent Profiles - only the authenticated user can access their own profile
    match /parentProfiles/{parentId} {
      allow read, write: if isOwnerOfParentProfile(parentId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Allow querying only your own profiles
      allow list: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // Kid Profiles - only the parent can manage their kids
    match /kidProfiles/{kidId} {
      allow read, write: if isAuthenticated() && (
        // Parent can access their own kid's profile
        isOwnerOfParentProfile(resource.data.parentId) ||
        // For creation, check the parent ID in the request
        (request.resource != null && isOwnerOfParentProfile(request.resource.data.parentId))
      );
      allow create: if isAuthenticated() &&
        isOwnerOfParentProfile(request.resource.data.parentId);
      allow list: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
    }

    // Recipes - only owners can manage their recipes
    match /recipes/{recipeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
      allow list: if isAuthenticated();
    }

    // Kid-friendly recipes - only owner access
    match /kidRecipes/{kidRecipeId} {
      allow read, write: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow list: if isAuthenticated();
    }

    // Global kid-friendly recipe cache - read-only for users, Cloud Functions manage writes
    match /kidRecipeCache/{cacheId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions should manage cache
      allow create: if false; // Only Cloud Functions should create cache entries
    }

    // Cooking Sessions - only for kid's parent
    match /cookingSessions/{sessionId} {
      allow read, write, create: if isAuthenticated() &&
        isParentOfKid(resource.data.kidId || request.resource.data.kidId);
      allow list: if isAuthenticated() &&
        isParentOfKid(resource.data.kidId);
    }

    // Family Meals - only for family members
    match /familyMeals/{mealId} {
      allow read, write: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
      allow create: if isAuthenticated() &&
        isOwnerOfParentProfile(request.resource.data.parentId);
      allow list: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
    }

    // Recipe Recommendations - read-only for authenticated users
    match /recipeRecommendations/{recommendationId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions should write recommendations
    }

    // Recipe sharing (sharedRecipes collection) - proper ownership validation
    match /sharedRecipes/{shareId} {
      allow read: if isAuthenticated() && (
        // Parent can read recipes shared with their kids
        (resource.data.kidId != null && isParentOfKid(resource.data.kidId)) ||
        // Parent can read recipes they shared
        (resource.data.parentId != null && isOwnerOfParentProfile(resource.data.parentId))
      );
      allow write: if isAuthenticated() && (
        (resource.data.kidId != null && isParentOfKid(resource.data.kidId)) ||
        (resource.data.parentId != null && isOwnerOfParentProfile(resource.data.parentId))
      );
      allow create: if isAuthenticated() && (
        (request.resource.data.kidId != null && isParentOfKid(request.resource.data.kidId)) ||
        (request.resource.data.parentId != null && isOwnerOfParentProfile(request.resource.data.parentId))
      );
      allow list: if isAuthenticated();
    }

    // Kid recipe ratings - parents can rate kid recipes they have access to
    match /kidRecipeRatings/{ratingId} {
      allow read, write: if isAuthenticated() && (
        // Parent who created the rating
        isOwnerOfParentProfile(resource.data.parentId)
      );
      allow create: if isAuthenticated() && (
        isOwnerOfParentProfile(request.resource.data.parentId)
      );
      allow list: if isAuthenticated() && (
        isOwnerOfParentProfile(resource.data.parentId)
      );
    }

    // Step reports - kids and parents can report issues with recipe steps
    match /stepReports/{reportId} {
      allow read, write: if isAuthenticated() && (
        // Parent who created the report
        isOwnerOfParentProfile(resource.data.parentId) ||
        // Kid the recipe was for (via parent ownership)
        isParentOfKid(resource.data.kidId)
      );
      allow create: if isAuthenticated() && (
        isOwnerOfParentProfile(request.resource.data.parentId) ||
        isParentOfKid(request.resource.data.kidId)
      );
      allow list: if isAuthenticated() && (
        isOwnerOfParentProfile(resource.data.parentId) ||
        isParentOfKid(resource.data.kidId)
      );
    }

    // Recipe import cache - accessible by authenticated users for caching recipe imports
    match /recipeImportCache/{cacheId} {
      allow read: if isAuthenticated();
      allow write, create: if isAuthenticated(); // Allow users to cache their imports
    }

    // Kid Progress tracking - only accessible by parents of the kid
    match /kidProgress/{kidId} {
      allow read, write: if isAuthenticated() && isParentOfKid(kidId);
      allow create: if isAuthenticated() && isParentOfKid(kidId);
      allow list: if isAuthenticated() && isParentOfKid(kidId);
    }

    // Rate limiting collection for tracking usage quotas
    match /rateLimits/{userId} {
      allow read, write: if isOwner(userId);
      allow create: if isAuthenticated() && userId == request.auth.uid;
    }

    // Recipe Favorites - parents can manage their own favorites and their kids' favorites
    match /recipeFavorites/{favoriteId} {
      // Allow read - handle both existing documents and non-existing documents
      allow read: if isAuthenticated() && (
        // If document doesn't exist, allow read for authenticated users to check
        resource == null ||
        // If document exists, check ownership
        (resource != null && (
          (resource.data.parentUserId != null && resource.data.parentUserId == request.auth.uid)
        ))
      );

      // Allow write (covers both create and update) - check the request data
      allow write: if isAuthenticated() && (
        // Parent creating/updating their own favorite (no kidId)
        request.resource.data.parentUserId == request.auth.uid
      );

      // Allow list for queries - authenticated users can query
      allow list: if isAuthenticated();
    }

    // Deny all other access
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
